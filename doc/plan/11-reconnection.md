# Phase 11: 再接続・リジューム

## 概要
接続が切れた場合の復帰処理を実装する。

## ゴール
- 一時的な切断から自動復帰。
- ブラウザリロード後も同じルームに戻れる。
- ゲーム中の切断でも進行が止まらない。

---

## 成果物
- 自動再接続ロジック
- セッション復元
- 切断時のフォールバック

---

## 機能要件

### サーバ側
| 機能 | 説明 |
|------|------|
| プレイヤー識別 | playerId をクライアント側で保持（localStorage） |
| 接続状態管理 | Player.connected フラグ |
| 再参加処理 | 同じ playerId で再接続時に状態復元 |
| 切断猶予 | 30秒間は切断扱いにしない（reconnect 待ち） |

### フロント側
| 機能 | 説明 |
|------|------|
| playerId 保存 | localStorage に保存 |
| 自動再接続 | 切断検知 → 3秒後に再接続試行（最大5回） |
| 状態復元 | 再接続後に現在のフェーズ・データを取得 |
| 切断表示 | 「接続が切れました...」UI |

---

## 再接続フロー

```
クライアント: WS 切断検知
  ↓
3秒待機 → 再接続試行
  ↓ (成功)
WS: rejoin_room { roomId, playerId }
  ↓
サーバ: Player.connected = true, 現在状態を返却
  ↓
クライアント: 状態復元、適切な画面へ遷移
```

---

## タスク

### サーバ
- [x] Player.connected フラグ管理
- [x] 切断時に即座に除外せず、30秒猶予
- [x] `rejoin_room` ハンドラ
- [x] 現在のゲーム状態を返却するロジック
- [x] 猶予期間超過で正式に切断扱い（未提出は自動提出）

### フロント
- [x] playerId を localStorage に保存
- [x] WS 切断検知（onclose イベント）
- [x] 再接続リトライロジック（指数バックオフ）
- [x] 「再接続中...」UI
- [x] 状態復元後の画面遷移

---

## 受け入れ条件
- [x] ネットワーク瞬断から自動復帰できる
- [x] ブラウザリロードしてもルームに戻れる
- [x] 30秒以上切断すると自動提出されてゲームは進行する
- [x] 他のプレイヤーのゲーム進行が止まらない

---

## 依存関係
- Phase 02 完了（基本的な WS 接続管理）

## 次フェーズへの引き継ぎ
- 堅牢な接続管理
