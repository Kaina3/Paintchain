# 14. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰

## æ¦‚è¦
å‰ã®äººãŒæã„ãŸçµµã‚’å…ƒã«ã€å°‘ã—ãšã¤å‹•ãã‚’åŠ ãˆãŸçµµã‚’æã„ã¦ã„ããƒ¢ãƒ¼ãƒ‰ã€‚
æœ€çµ‚çš„ã«å…¨ã¦ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é€£ç¶šå†ç”Ÿã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ¥½ã—ã‚€ã€‚

## ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼

```
1. æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ æç”»
   - è¨­å®šã«ã‚ˆã‚Šã€Œè‡ªç”±ã«æãã€ã¾ãŸã¯ã€ŒãŠé¡Œã‚’è¦‹ã¦æãã€
   
2. æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ï¼ˆç¹°ã‚Šè¿”ã—ï¼‰
   - å‰ã®çµµï¼ˆã¾ãŸã¯æœ€åˆã‹ã‚‰ã®é€£ç¶šï¼‰ã‚’è¦‹ã¦
   - å°‘ã—å‹•ã‹ã—ãŸçµµã‚’æã
   
3. çµæœè¡¨ç¤º
   - ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é€£ç¶šå†ç”Ÿã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
   - å†ç”Ÿé€Ÿåº¦ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§èª¿æ•´å¯èƒ½
```

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### ãƒã‚§ãƒ¼ãƒ³æ§‹é€ 
```typescript
interface AnimationChain {
  id: string;
  roomId: string;
  ownerPlayerId: string;  // æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æã„ãŸäºº
  frames: AnimationFrame[];
}

interface AnimationFrame {
  order: number;
  authorId: string;
  imageData: string;      // base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ
  submittedAt: Date;
}
```

### ãƒ•ã‚§ãƒ¼ã‚ºå®šç¾©
```typescript
type AnimationPhase = 
  | 'first-frame'    // æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆè‡ªç”± or ãŠé¡Œã‚ã‚Šï¼‰
  | 'prompt'         // ãŠé¡Œå…¥åŠ›ï¼ˆfirstFrameMode='prompt'ã®å ´åˆã®ã¿ï¼‰
  | 'drawing'        // ãƒ•ãƒ¬ãƒ¼ãƒ æç”»
  | 'result';        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ

// ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã®'guessing'ãƒ•ã‚§ãƒ¼ã‚ºã¯ä¸è¦
```

## è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³

```typescript
interface AnimationModeSettings {
  drawingTimeSec: number;           // æç”»æ™‚é–“ (default: 90)
  viewMode: 'previous' | 'sequence'; // å‰ã®çµµã®è¡¨ç¤ºæ–¹æ³• (default: 'sequence')
  firstFrameMode: 'free' | 'prompt'; // æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ  (default: 'free')
  promptTimeSec?: number;           // ãŠé¡Œå…¥åŠ›æ™‚é–“ (default: 20)
}
```

### viewMode ã®èª¬æ˜
- `previous`: ç›´å‰ã®1ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã¿è¡¨ç¤º
- `sequence`: æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ç¾åœ¨ã¾ã§ã‚’é€£ç¶šå†ç”Ÿè¡¨ç¤º

### firstFrameMode ã®èª¬æ˜
- `free`: æœ€åˆã®äººãŒè‡ªç”±ã«çµµã‚’æã
- `prompt`: ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã®ã‚ˆã†ã«ãŠé¡Œã‚’å…¥åŠ›ã—ã€ãã‚Œã«åŸºã¥ã„ã¦æã

## å®Ÿè£…ã‚¿ã‚¹ã‚¯

### 14.1 AnimationModeHandler ã®å®Ÿè£…

```typescript
// server/src/application/gameModes/animationMode.ts

export class AnimationModeHandler implements GameModeHandler {
  getPhases(): GamePhase[] {
    // firstFrameModeã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹
    return this.settings.firstFrameMode === 'prompt'
      ? ['prompt', 'first-frame', 'drawing', 'result']
      : ['first-frame', 'drawing', 'result'];
  }

  getNextPhase(currentPhase: GamePhase, turn: number, totalTurns: number): GamePhase | 'result' {
    if (currentPhase === 'prompt') return 'first-frame';
    if (currentPhase === 'first-frame') return 'drawing';
    if (currentPhase === 'drawing') {
      return turn < totalTurns - 1 ? 'drawing' : 'result';
    }
    return 'result';
  }

  distributeContent(room: Room, chains: Chain[]): Map<string, ContentPayload> {
    const viewMode = room.settings.animationSettings.viewMode;
    // viewModeã«å¿œã˜ã¦å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¾ãŸã¯ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’é…å¸ƒ
    // ...
  }
}
```

### 14.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ - æç”»ç”»é¢

#### å‚ç…§è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
// AnimationReference.tsx

interface Props {
  frames: AnimationFrame[];
  viewMode: 'previous' | 'sequence';
}

// viewMode='previous': æœ€å¾Œã®1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é™æ­¢ç”»ã§è¡¨ç¤º
// viewMode='sequence': å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è‡ªå‹•å†ç”Ÿï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
```

#### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¿ãƒ¼ãƒ³ 3/6                              æ®‹ã‚Š 85ç§’     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                 â”‚    â”‚                         â”‚    â”‚
â”‚  â”‚  å‚ç…§è¡¨ç¤º       â”‚    â”‚    æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹       â”‚    â”‚
â”‚  â”‚  (å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ   â”‚    â”‚                         â”‚    â”‚
â”‚  â”‚   ã¾ãŸã¯ã‚¢ãƒ‹ãƒ¡) â”‚    â”‚                         â”‚    â”‚
â”‚  â”‚                 â”‚    â”‚                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  [sequenceè¡¨ç¤ºã®å ´åˆ: å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³]             â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [è‰²é¸æŠ] [ãƒšãƒ³ã‚µã‚¤ã‚º] [æ¶ˆã—ã‚´ãƒ ] [ã‚¯ãƒªã‚¢]   [æå‡º]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.3 çµæœç”»é¢ - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ

#### AnimationResult.tsx
```typescript
interface AnimationResultProps {
  chains: AnimationChain[];
}

// æ©Ÿèƒ½:
// - ãƒã‚§ãƒ¼ãƒ³é¸æŠï¼ˆè¤‡æ•°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
// - ãƒ•ãƒ¬ãƒ¼ãƒ é€£ç¶šå†ç”Ÿ
// - å†ç”Ÿé€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆFPSèª¿æ•´: 1ã€œ30fpsï¼‰
// - å†ç”Ÿ/ä¸€æ™‚åœæ­¢
// - ãƒ•ãƒ¬ãƒ¼ãƒ é€ã‚Šï¼ˆã‚³ãƒé€ã‚Šï¼‰
// - ãƒ«ãƒ¼ãƒ—å†ç”Ÿã‚ªãƒ³/ã‚ªãƒ•
```

#### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† ãƒã‚§ãƒ¼ãƒ³é¸æŠ   â”‚
â”‚  â”‚ ğŸ‘¤ A    â”‚ â”‚ ğŸ‘¤ B    â”‚ â”‚ ğŸ‘¤ C    â”‚                   â”‚
â”‚  â”‚ [thumb] â”‚ â”‚ [thumb] â”‚ â”‚ [thumb] â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚            ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒªã‚¢             â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â”‚                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  [â—€â—€] [â–¶/â¸] [â–¶â–¶]    ãƒ•ãƒ¬ãƒ¼ãƒ : 3/6                      â”‚
â”‚                                                         â”‚
â”‚  å†ç”Ÿé€Ÿåº¦: â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10fps                       â”‚
â”‚                                                         â”‚
â”‚  â˜‘ ãƒ«ãƒ¼ãƒ—å†ç”Ÿ                                          â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹]                    [GIFä¿å­˜] [å…±æœ‰]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.4 å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

#### Step 1: ãƒ¢ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
1. `AnimationModeHandler` ã‚¯ãƒ©ã‚¹ä½œæˆ
2. ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
3. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…å¸ƒãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…

#### Step 2: ã‚µãƒ¼ãƒãƒ¼å´å¯¾å¿œ
1. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒã‚§ãƒ¼ãƒ³ç®¡ç†
2. ãƒ•ãƒ¬ãƒ¼ãƒ æå‡ºå‡¦ç†
3. çµæœãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ

#### Step 3: æç”»ç”»é¢
1. `AnimationReference.tsx` ä½œæˆ
2. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å†ç”Ÿæ©Ÿèƒ½
3. æç”»ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´

#### Step 4: çµæœç”»é¢
1. `AnimationResult.tsx` ä½œæˆ
2. ãƒ•ãƒ¬ãƒ¼ãƒ å†ç”Ÿæ©Ÿèƒ½
3. é€Ÿåº¦èª¿æ•´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
4. GIFå‡ºåŠ›æ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### 14.5 æŠ€è¡“çš„è€ƒæ…®äº‹é …

#### ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å†ç”Ÿã®å®Ÿè£…
```typescript
// useAnimationPlayback.ts

function useAnimationPlayback(frames: string[], fps: number) {
  const [currentFrame, setCurrentFrame] = useState(0);
  const [isPlaying, setIsPlaying] = useState(true);
  
  useEffect(() => {
    if (!isPlaying) return;
    
    const interval = setInterval(() => {
      setCurrentFrame(prev => (prev + 1) % frames.length);
    }, 1000 / fps);
    
    return () => clearInterval(interval);
  }, [isPlaying, fps, frames.length]);
  
  return { currentFrame, isPlaying, setIsPlaying, setCurrentFrame };
}
```

#### ç”»åƒãƒ‡ãƒ¼ã‚¿ã®æœ€é©åŒ–
- Canvasâ†’PNG base64ã¯é‡ã„ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦åœ§ç¸®
- ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãŒå¤šã„å ´åˆã®å¸¯åŸŸè€ƒæ…®
- WebSocketã§ã®ç”»åƒé€ä¿¡ã‚µã‚¤ã‚ºåˆ¶é™

## ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ä¸€è¦§

### æ–°è¦ä½œæˆ
- `server/src/application/gameModes/animationMode.ts`
- `frontend/src/features/game/components/AnimationReference.tsx`
- `frontend/src/features/game/components/AnimationResult.tsx`
- `frontend/src/features/game/hooks/useAnimationPlayback.ts`

### ä¿®æ­£
- `server/src/application/gameUseCases.ts` - ãƒ¢ãƒ¼ãƒ‰åˆ†å²è¿½åŠ 
- `frontend/src/features/game/pages/GamePage.tsx` - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
- `frontend/src/features/game/components/DrawingCanvas.tsx` - å‚ç…§è¡¨ç¤ºçµ±åˆ

## å®Œäº†æ¡ä»¶
- [ ] æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è‡ªç”±ã«æã‘ã‚‹
- [ ] å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆã¾ãŸã¯é€£ç¶šï¼‰ã‚’è¦‹ãªãŒã‚‰æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æã‘ã‚‹
- [ ] viewModeè¨­å®šãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹
- [ ] çµæœç”»é¢ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã§ãã‚‹
- [ ] å†ç”Ÿé€Ÿåº¦ã‚’èª¿æ•´ã§ãã‚‹
- [ ] è¤‡æ•°ãƒã‚§ãƒ¼ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã¦è¦‹ã‚‰ã‚Œã‚‹
